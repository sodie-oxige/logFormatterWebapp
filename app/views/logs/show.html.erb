<% content_for(:title, @log_content.log[:name]) %>
<%= stylesheet_link_tag "show", "data-turbo-track": "reload" %>

<div id="screen">
    <%= turbo_frame_tag "comment_container", style:"position:static" do %>
        <div id="backgrond"></div>
        <% img = Character.where("REPLACE(name, ' ', '') = ?", @log_content[:author].gsub(/\s+/, '')).exists? ? Character.find_by("REPLACE(name, ' ', '') = ?", @log_content[:author].gsub(/\s+/, '')).images[0] : nil %>
        <% img ||= Nickname.where("REPLACE(name, ' ', '') = ?", @log_content[:author].gsub(/\s+/, '')).exists? ? Nickname.find_by("REPLACE(name, ' ', '') = ?", @log_content[:author].gsub(/\s+/, '')).character.images[0] : nil %>
        <%= image_tag img||"", id:"imageL" %>
        <img src="" id="imageR">

        <div id="mask"></div>
        <% if Log.find(@id).log_contents.exists?(index: @page.to_i-1) %>
            <%= link_to "", log_path(@id,page: @page.to_i-1), {id:"show-button-back", class:"show-button" } %>
        <% else %>
            <%= link_to "", nil, {id:"show-button-back", class:"show-button", style:"pointer-events:none;" } %>
        <% end %>
        <div data-url="<%= (Log.find(@id).log_contents.exists?(index: @page.to_i+1) ? log_path(@id,page: @page.to_i+1) : logs_path) %>" id="comment" tab="<%= @log_content[:tab] %>" style="--color: <%= @log_content[:color] %>">
            <div id="comment_name">
                <span><%= @log_content[:author] %></span>
            </div>
            <div id="comment_content">
                <p></p>
            </div>
        </div>

        <script>
            document.addEventListener("turbo:load", function(e) {
                textfeed(`<%= j @log_content[:content] %>`);
            }, {once: true});
        </script>
    <% end %>
</div>

<script>
    window.textfeed = (text) =>{
        let hidden = text;
        document.querySelector("#comment_content>p").innerHTML="";
        
        let inter = setInterval(() => {
            
            if(!!hidden){
                let char;
                if(/^&.+?;/.test(hidden)){
                    char = hidden.match(/^&.+?;/)[0];
                    hidden = hidden.replace(/^&.+?;/, "");
                }else{
                    char = hidden.slice(0,1);
                    hidden = hidden.slice(1);
                }
                document.querySelector("#comment_content>p").innerHTML += char === "\n" ? "<br>" : char;
            }else{
                clearInterval(inter);
            }
        }, 15);
        window.addEventListener("turbo:before-visit", ()=>{
            clearInterval(inter);
        }, {once: true})
    }
</script>